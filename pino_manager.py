#!/usr/bin/python3

import configparser
import subprocess
import time

def check_auto_boot_config():
    config = configparser.ConfigParser()
    #try:
    with open("/boot/PinoBot/PinoConfig.ini") as f:
        config.read_file(f)
    if config['BOOT'].getboolean("AutoBoot") :
        return 1
    else :
        return 0
    #except:
        #return 0

def update():
    # TODO - using github, update pinobot pacakge
    pass


def main_boot():
    loding_str =      ( '     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@--@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@@@ ---:@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@@----~::@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@,--,,-~:@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@--,,,.,~:@@@@@::---@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@--,...,~:@@@@:~~---@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@----,,,,~:@@@:~-----@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@------,,,~:@@@:~,,,---@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@-----,---~~@@:~-.,,,--@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@----,...,,,,..~-~-,,,--@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@---,...........--~,,---@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@  ....---.............-~-,---@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@,,....~-,.....~!~.......,----@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@--,,,.@-......:$:.~-... ..--- @@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@..---,,:@.......,..;~......---@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@-,.@@--~--.   . ,---,.......---@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@--. ::~----.   .,---,......,---@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@--...,~,..--....,---,......--- @@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@-----,...,. .  ,---,..,--...@@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@:~----,..-.........,..@,. @@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@---,...,-,.... ..-.,:-..,@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@--,...,,.....,-~~,~:-...@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@...,. ,-. .,,~:::-...@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@-.  :$:  .,,~---...@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@@   ~!~  ...,----@@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@@..     ....,----@@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@;-, ,~, ,,..,---@@@@@@@@@@@@@@@@@@@@@      \n' 
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@--, :$: ,-..,--@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@--,.-:-.,--@@@@@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@,,--,...,,,,,@@@@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@,,---,,,,,,,,@@@@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@,,,--,,,,,,,,@@@@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '     @@@@@@@@@@@@@@@@@@@@@@@@...............@@@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '     @@@@@@@@@@@@@@@@@@@@@@@@...         ...@@@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '     @@@@@@@@@@@@@@@@@@@@@@@@...         ...@@@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '     @@@@@@@@@@@@@@@@@@@@@@@@ ..         ...@@@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      \n'
                        '   _   _        _  _         ______  _               ______         _     \n'
                        '  | | | |      | || |        | ___ \(_)              | ___ \       | |    \n'
                        '  | |_| |  ___ | || |  ___   | |_/ / _  _ __    ___  | |_/ /  ___  | |_   \n'
                        "  |  _  | / _ \| || | / _ \  |  __/ | || '_ \  / _ \ | ___ \ / _ \ | __|  \n"
                        '  | | | ||  __/| || || (_) | | |    | || | | || (_) || |_/ /| (_) || |_   \n'
                        '  \_| |_/ \___||_||_| \___/  \_|    |_||_| |_| \___/ \____/  \___/  \__|  \n\n'
                        '==========================================================================\n'
                        "  Launch PinoBot Manager...\n"
                        '==========================================================================\n')

    print("\n\nchecking PinoMain.py")
    with open("/dev/tty1", 'w') as tty0:
        tty0.write("\n\nchecking PinoMain.py\n")
    boot_config = check_auto_boot_config()
    main_process = None

    try:
        while boot_config == 0:
            #print("[PinoManager] check PinoBot process")
            ps_list = subprocess.run("ps -ef | grep py", shell=True, stdout=subprocess.PIPE).stdout.decode()

            if "pino_main.py" in ps_list:
                print("[PinoManager] pino_bot running ignore")
                pass
            else:
                print("[PinoManager] no PinoBot, launch")
                print(loding_str)
                with open("/dev/tty1", 'w') as tty0:
                    tty0.write(loding_str)
                    main_process = subprocess.Popen("sudo python3 ./pino_main.py &>> /dev/tty1", shell=True,cwd="/home/pi/Desktop/PinoBot/",
                                      stdout=tty0,stderr=tty0)
                if main_process.returncode == 127:
                    print("[PinoManager] Invalid install")
                    return 0
                elif main_process.returncode == 137:
                    print("[PinoManager] kill command, restart pinobot")

                # wait until process, dead

            time.sleep(3)
    except :
        # TODO, if parent(pino manager) is dead, kill pino main
        if main_process is not None:
            main_process.terminate()
            main_process.kill()

if __name__ == '__main__':
    main_boot()


